<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          screens: {
            lon: "1146px", // Custom breakpoint
          },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
  <link rel="icon" href="/favicon.png" type="image/x-icon">
  <title>KhaataBook Project</title>
  <style>
    /* Optional: Add very specific custom styles here if Tailwind isn't enough */
    body {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
  </style>
</head>

<body class="text-zinc-900 bg-zinc-100 dark:bg-zinc-900 dark:text-zinc-100">
  <div class="w-full min-h-screen font-['Roboto_Condensed']">
    <nav class="w-full h-auto min-h-[8vh] bg-white dark:bg-zinc-800 shadow-md px-4 sm:px-6 lg:px-10 py-3 flex flex-col sm:flex-row items-center justify-between gap-4 sm:gap-0">
      <h1 class="text-2xl font-semibold text-blue-600 dark:text-blue-400 sm:text-3xl">KhaataBook</h1>

      <ul class="flex flex-wrap gap-y-2 gap-x-5 justify-center items-center">
        <li>
          <a class="text-sm font-medium transition-colors text-zinc-700 underline-offset-4 hover:underline dark:text-zinc-300 sm:text-base hover:text-blue-600 dark:hover:text-blue-400" href="/">Home</a>
        </li>
        <li>
          <a class="text-sm font-medium transition-colors text-zinc-700 underline-offset-4 hover:underline dark:text-zinc-300 sm:text-base hover:text-blue-600 dark:hover:text-blue-400" href="/create">Create Hisaab</a>
        </li>
        <li>
          <a class="text-sm font-medium transition-colors text-zinc-700 underline-offset-4 hover:underline dark:text-zinc-300 sm:text-base hover:text-blue-600 dark:hover:text-blue-400" href="/logout">Logout</a>
        </li>
        <li>
          <label class="inline-flex relative items-center cursor-pointer">
            <input class="sr-only peer" id="toggle-theme" type="checkbox" />
            <div class="relative w-[70px] sm:w-[80px] h-[30px] sm:h-[35px] bg-zinc-200 dark:bg-zinc-700 peer-checked:bg-zinc-600 rounded-full
                        after:absolute after:content-[''] after:w-[25px] sm:after:w-[30px] after:h-[25px] sm:after:h-[30px]
                        after:bg-gradient-to-r after:from-orange-500 after:to-yellow-400
                        peer-checked:after:from-zinc-800 peer-checked:after:to-zinc-900
                        after:rounded-full after:top-[2.5px] sm:after:top-[2.5px] after:left-[5px]
                        peer-checked:after:translate-x-[calc(100%+10px)] sm:peer-checked:after:translate-x-[calc(100%+12px)]
                        shadow-inner after:shadow-md transition-all duration-300 after:transition-all after:duration-300">
            </div>
            <svg class="fill-zinc-100 absolute w-4 sm:w-5 h-4 sm:h-5 left-[8px] sm:left-[10px] top-1/2 -translate-y-1/2 opacity-100 peer-checked:opacity-0 transition-opacity duration-300" height="0" width="100" viewBox="0 0 24 24" data-name="Layer 1" id="Layer_1_sun" xmlns="http://www.w3.org/2000/svg">
              <path d="M12,17c-2.76,0-5-2.24-5-5s2.24-5,5-5,5,2.24,5,5-2.24,5-5,5ZM13,0h-2V5h2V0Zm0,19h-2v5h2v-5ZM5,11H0v2H5v-2Zm19,0h-5v2h5v-2Zm-2.81-6.78l-1.41-1.41-3.54,3.54,1.41,1.41,3.54-3.54ZM7.76,17.66l-1.41-1.41-3.54,3.54,1.41,1.41,3.54-3.54Zm0-11.31l-3.54-3.54-1.41,1.41,3.54,3.54,1.41-1.41Zm13.44,13.44l-3.54-3.54-1.41,1.41,3.54,3.54,1.41-1.41Z"></path>
            </svg>
            <svg class="fill-slate-300 absolute w-4 sm:w-5 h-4 sm:h-5 right-[8px] sm:right-[10px] top-1/2 -translate-y-1/2 opacity-0 peer-checked:opacity-100 transition-opacity duration-300" height="512" width="512" viewBox="0 0 24 24" data-name="Layer 1" id="Layer_1_moon" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.009,24A12.067,12.067,0,0,1,.075,10.725,12.121,12.121,0,0,1,10.1.152a13,13,0,0,1,5.03.206,2.5,2.5,0,0,1,1.8,1.8,2.47,2.47,0,0,1-.7,2.425c-4.559,4.168-4.165,10.645.807,14.412h0a2.5,2.5,0,0,1-.7,4.319A13.875,13.875,0,0,1,12.009,24Zm.074-22a10.776,10.776,0,0,0-1.675.127a10.1,10.1,0,0,0-8.344,8.8A9.928,9.928,0,0,0,4.581,18.7a10.473,10.473,0,0,0,11.093,2.734.5.5,0,0,0,.138-.856h0C9.883,16.1,9.417,8.087,14.865,3.124a.459.459,0,0,0,.127-.465.491.491,0,0,0-.356-.362A10.68,10.68,0,0,0,12.083,2ZM20.5,12a1,1,0,0,1-.97-.757l-.358-1.43L17.74,9.428a1,1,0,0,1,.035-1.94l1.4-.325.351-1.406a1,1,0,0,1,1.94,0l.355,1.418,1.418.355a1,1,0,0,1,0,1.94l-1.418.355-.355,1.418A1,1,0,0,1,20.5,12ZM16,14a1,1,0,0,0,2,0A1,1,0,0,0,16,14Zm6,4a1,1,0,0,0,2,0A1,1,0,0,0,22,18Z"></path>
            </svg>
          </label>
        </li>
      </ul>
    </nav>

    <div class="p-4 sm:p-6 lg:p-10">
      <h1 class="mb-6 text-2xl font-semibold text-zinc-800 dark:text-zinc-200 sm:text-3xl sm:mb-10">All Hisaab Kitaab</h1>
      <div class="flex flex-col gap-6 justify-start items-start p-4 mb-8 bg-white rounded-lg shadow sm:mb-12 sm:flex-row sm:items-center sm:gap-10 dark:bg-zinc-800">
        <h3 class="text-lg font-medium sm:text-xl text-zinc-700 dark:text-zinc-300"><i class="mr-2 align-middle ri-equalizer-line"></i>Filters</h3>
        <form action="/filter" method="POST" class="flex flex-wrap gap-3 items-center">
          <div class="relative w-max">
            <select name="filterSelect" class="py-2.5 pr-10 pl-4 text-sm rounded-lg border transition-colors appearance-none border-zinc-300 dark:border-zinc-600 text-zinc-800 bg-zinc-50 dark:text-zinc-100 dark:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="all" <%= filterSelect === 'all' ? 'selected' : '' %>>All</option>
              <option value="new" <%= filterSelect === 'new' ? 'selected' : '' %>>Newest first</option>
              <option value="old" <%= filterSelect === 'old' ? 'selected' : '' %>>Oldest first</option>
            </select>
            <div class="flex absolute inset-y-0 right-3 items-center pointer-events-none">
              <svg class="w-5 h-5 text-zinc-500 dark:text-zinc-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          <input type="date" name="filterDate" value="<%= filterDate ? filterDate : '' %>" class="px-4 py-2 text-sm rounded-lg border transition-colors border-zinc-300 dark:border-zinc-600 text-zinc-800 dark:text-zinc-100 bg-zinc-50 dark:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="submit" value="Apply Filters" class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 duration-300 transform hover:scale-[0.98] active:scale-[0.95] rounded-lg text-white text-sm font-medium cursor-pointer transition-all" />
        </form>
      </div>

      <div class="grid grid-cols-1 gap-5 w-full h-fit sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 sm:gap-6">
        <% if(files.length > 0){ files.forEach((file) => { %>
        <div class="flex flex-col gap-3 p-5 w-full bg-white rounded-xl border shadow-lg transition-shadow duration-300 h-fit border-zinc-200 dark:border-zinc-700 dark:bg-zinc-800 hover:shadow-xl">
          <% if (error && file.filename == filename) { %>
          <div class="px-4 py-3 mb-2 text-white bg-red-600 rounded-lg">
            <p class="text-sm font-medium"><i class="mr-2 ri-error-warning-line"></i><%= error %></p>
          </div>
          <% } else { %>
          <div class="flex flex-col gap-2 justify-between items-start select-none sm:flex-row sm:items-center">
            <div class="flex flex-wrap gap-2 items-center">
              <p class="px-3 py-1.5 text-xs font-medium text-white rounded-full
                        <% if (file.isEncrypted) { %> bg-red-500 dark:bg-red-600 <% } else { %> bg-green-500 dark:bg-green-600 <% } %>">
                <% if (file.isEncrypted) { %>
                <i class="mr-1 align-middle ri-lock-2-line"></i>Encrypted
                <% } else { %>
                <i class="mr-1 align-middle ri-check-line"></i>Available
                <% } %>
              </p>
              <p class="px-3 py-1.5 text-xs font-medium text-white rounded-full
                        <% if (file.isShareable) { %> bg-sky-500 dark:bg-sky-600 <% } else { %> bg-amber-500 dark:bg-amber-600 <% } %>">
                <% if (file.isShareable) { %>
                <i class="mr-1 align-middle ri-share-line"></i>Shareable
                <% } else { %>
                <i class="mr-1 align-middle ri-eye-off-line"></i>Private
                <% } %>
              </p>
            </div>
            <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400 sm:text-sm sm:mt-0">
              <i class="mr-1 align-middle ri-calendar-2-line"></i><%= new Date(file.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
            </p>
          </div>
          <% } %>

          <h3 class="my-2 text-lg font-semibold break-words text-zinc-800 sm:text-xl lg:text-2xl dark:text-zinc-100"><%= file.title.slice(0,40) %><% if(file.title.length > 40) { %>...<% } %></h3>

          <% if (file.isEncrypted) { %>
          <p class="mb-2 text-sm text-zinc-600 dark:text-zinc-400">This file is encrypted. Please enter the password to unlock and view its content.</p>
          <div class="flex flex-col gap-3 items-stretch">
            <form class="flex flex-col flex-1 gap-3 sm:flex-row sm:gap-3" action="/fileCheck/<%=file.filename%>" method="POST">
              <div class="relative flex-1">
                <input class="px-4 py-2.5 pr-12 w-full text-sm rounded-lg border-2 transition-all outline-none border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-700 text-zinc-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-zinc-400 dark:placeholder-zinc-500" type="password" name="ePassword" placeholder="Enter Password">
                <button type="button" class="absolute right-3 top-1/2 px-1 py-0.5 rounded-md transition-colors transform -translate-y-1/2 text-zinc-500 dark:text-zinc-400 hover:text-blue-600 dark:hover:text-blue-400 password-toggle-button">
                  <i class="inline-block text-lg eye-icon ri-eye-line"></i>
                  <i class="hidden text-lg eye-off-icon ri-eye-off-line"></i>
                </button>
              </div>
              <input class="px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 dark:bg-zinc-200 dark:hover:bg-zinc-300 text-zinc-100 dark:text-zinc-900 duration-300 transform hover:scale-[0.98] active:scale-[0.95] rounded-lg cursor-pointer text-sm font-medium transition-all" type="submit" value="Unlock Hisaab">
            </form>
            <a href="/edit/<%= file.filename %>" class="px-4 py-2.5 bg-teal-600 hover:bg-teal-700 duration-300 transform hover:scale-[0.98] active:scale-[0.95] rounded-lg text-center text-white text-sm font-medium transition-all">
              <i class="mr-1 align-middle ri-edit-box-line"></i> Edit Details
            </a>
          </div>
          <% } else { %>
          <p class="text-sm text-zinc-600 dark:text-zinc-400 mb-1 flex-grow min-h-[40px]">
            <% if (file.description && file.description.length > 0) { %>
              <%= file.description.slice(0, 80) %><% if(file.description.length > 80) { %>...<% } %>
            <% } else { %>
              No description available for this hisaab. Click 'View Hisaab' to see details.
            <% } %>
          </p>
          <div class="flex flex-col gap-3 justify-between items-stretch pt-3 mt-auto sm:flex-row sm:items-center">
            <a href="/view/<%= file.filename %>" class="w-full sm:w-auto px-4 py-2.5 bg-blue-600 hover:bg-blue-700 duration-300 transform hover:scale-[0.98] active:scale-[0.95] rounded-lg text-center text-white text-sm font-medium transition-all flex-grow sm:flex-grow-0">
              View Hisaab <i class="ml-1 align-middle ri-arrow-right-line"></i>
            </a>
            <div class="flex gap-2 items-center sm:gap-3">
              <a href="/edit/<%= file.filename %>" class="flex-1 sm:flex-none px-4 py-2.5 bg-teal-600 hover:bg-teal-700 duration-300 transform hover:scale-[0.98] active:scale-[0.95] rounded-lg text-center text-white text-sm font-medium transition-all">
                <i class="align-middle ri-edit-box-line"></i> <span class="sm:hidden lg:inline">Edit</span>
              </a>
              <a href="/delete/<%= file.filename %>" class="flex-1 sm:flex-none px-4 py-2.5 bg-red-600 hover:bg-red-700 duration-300 transform hover:scale-[0.98] active:scale-[0.95] rounded-lg text-center text-white text-sm font-medium transition-all">
                <i class="align-middle ri-delete-bin-6-line"></i> <span class="sm:hidden lg:inline">Delete</span>
              </a>
            </div>
          </div>
          <% } %>
        </div>
        <% });} else { %>
        <div class="col-span-full">
          <div class="px-6 py-10 text-center bg-amber-50 rounded-xl border-2 border-amber-200 dark:bg-amber-900/30 dark:border-amber-800/50">
            <i class="mb-4 text-5xl text-amber-500 ri-folder-open-line dark:text-amber-400"></i>
            <h1 class="text-xl font-semibold text-amber-800 dark:text-amber-200 sm:text-2xl lg:text-3xl">
              No Hisaab Kitaab Found
            </h1>
            <p class="mt-3 text-sm text-amber-600 dark:text-amber-300 sm:text-base">
              It looks like your KhaataBook is empty or the filters returned no results.
            </p>
            <a href="/create" class="inline-block px-6 py-2.5 mt-6 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md transition-all duration-300 transform hover:bg-blue-700 hover:shadow-lg hover:scale-105">
                Create New Hisaab
            </a>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggleButton = document.getElementById("toggle-theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

      // Function to apply theme
      function applyTheme(theme) {
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
          if (toggleButton) toggleButton.checked = true;
        } else {
          document.documentElement.classList.remove("dark");
          if (toggleButton) toggleButton.checked = false;
        }
      }

      // Check local storage first, then system preference
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        applyTheme(savedTheme);
      } else {
        applyTheme(prefersDark ? "dark" : "light");
      }

      // Theme toggle functionality
      if (toggleButton) {
        toggleButton.addEventListener("click", () => {
          const isDark = document.documentElement.classList.toggle("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
        });
      }

      // Password visibility toggle for each card
      // Select all password toggle buttons. This is more specific.
      const passwordToggleButtons = document.querySelectorAll(".password-toggle-button");

      passwordToggleButtons.forEach((button) => {
        const form = button.closest('form'); // Find the closest form ancestor
        if (!form) return;

        const passwordInput = form.querySelector('input[name="ePassword"]');
        const eyeIcon = button.querySelector(".eye-icon");
        const eyeOffIcon = button.querySelector(".eye-off-icon");

        if (passwordInput && eyeIcon && eyeOffIcon) {
          button.addEventListener("click", () => {
            if (passwordInput.type === "password") {
              passwordInput.type = "text";
              eyeIcon.style.display = "none";
              eyeOffIcon.style.display = "inline-block";
            } else {
              passwordInput.type = "password";
              eyeOffIcon.style.display = "none";
              eyeIcon.style.display = "inline-block";
            }
          });
        }
      });

      // Update "Created At" date format to be more readable
      const dateElements = document.querySelectorAll('.text-xs.sm\\:text-sm[class*="dark:text-zinc-400"]'); // A bit hacky selector, better to add a specific class
      dateElements.forEach(el => {
          if (el.textContent.includes('Created:')) { // Check if it's the date element
            // The EJS part `new Date(file.createdAt).toLocaleDateString(...)` already handles formatting.
            // This client-side update isn't strictly necessary if EJS provides formatted date.
            // Kept the EJS date formatting as it's better to do it server-side or during templating.
          }
      });

    });
  </script>
</body>
</html>